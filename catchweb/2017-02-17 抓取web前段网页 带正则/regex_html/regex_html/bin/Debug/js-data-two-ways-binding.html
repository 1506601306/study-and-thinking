<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="0FNbiBWk1FugWYo-RiGxQyIHebGeLoXp3HB7AxIFKy8" />
    <meta name="baidu-site-verification" content="tYoUqpkCCv" />
    <meta name="baidu-site-verification" content="IGN97NW90O" />
    
    <title>javascript实现数据双向绑定的三种方式 | ouvenzhang的博客</title>

    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <link rel="dns-prefetch" href="cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="1.url.cn" />

    <meta name="description" itemprop="description" content="javascript实现数据双向绑定的三种方式,javascript,数据双向绑定,mvvm ">
    <meta itemprop="name" content="javascript实现数据双向绑定的三种方式">
    <meta itemprop="image" content="http://ouvens.github.io/blog/assets/logo.png">
    <meta itemprop="keywords" name="keywords" content="javascript实现数据双向绑定的三种方式,javascript,数据双向绑定,mvvm ">

    
    <meta name="author" content="ouvenzhang">
    <meta name="copyright" content="&copy; ouvenzhang 2017">
    <meta name="protocol" content="1">
    

    <!-- External libraries -->
    <link rel="stylesheet" href="/assets/css/iconfont.css">
    <link rel="stylesheet" href="/css/monokai_sublime.css">

    <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  	<link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
  	<meta name="msapplication-TileColor" content="#ffffff">
  	<meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icons/icon.png">

  	<!-- Site styles -->
    <link rel="stylesheet" href="/css/main.css">

    <link rel="alternate" type="application/rss+xml" title="极限前端" href="http://ouvens.github.io//feed.xml" />
    <script>
    // 访问统计
    var domain = 'jixianqianduan.com';
    var oldDomain = 'ouvens.github.io';
    if(location.host === domain){
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?b536b128dc21c3d18fdc028f0609e3f0";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }else if(location.host === oldDomain){
        window.location.href = location.href.replace(oldDomain, domain);
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?041efd2cb345ca1b9dbdbb2383cb716d";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }

    // 链接提交

    if(location.protocol === 'https'){
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,t=document.referrer;if(!e.test(r)){var o="https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif";t?(o+="?r="+encodeURIComponent(document.referrer),r&&(o+="&l="+r)):r&&(o+="?l="+r);var i=new Image;i.src=o}}(window);
    }else{
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
    }


    </script>
</head>

    <body>
        <div class="navigation" role="banner">
    <div class="navigation-wrapper">
    <a href="/" class="logo">
    	
      <img src="/assets/logo.png" alt="极限前端">
      
    </a>
    <span class="search-input" id="search-input">
      <input type="text" value="" class="search-text" placeholder="输入搜索关键字">
      <i class="icon-font i-search search-btn"></i>
    </span>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
    	<i class="icon-font i-list fa fa-bars"></i>
    </a>
    <span class="nav" role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
      	
          
          <li class="nav-link">
            <a href="/about/">关于</a>
          </li>
          
        
          
        
          
        
          
        
          
          <li class="nav-link">
            <a href="/category/">所有文章</a>
          </li>
          
        
          
          <li class="nav-link">
            <a href="/tags/">标签分类</a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          <li id="github-info" class="nav-link" title="https://github.com/ouvens">
            <a class="github-info" href="https://github.com/ouvens" target="_blank">
            <img src="/assets/github.png" height="34" width="130" alt="github地址"></a>
          </li>
      </ul>
    </span>
  </div>
</div>

            <div class="page-content">
        <div class="post">
<div class="post-header-container has-cover">
	<header class="post-header">
	  <h1 class="title">javascript实现数据双向绑定的三种方式</h1>
	  <p class="info">by <strong>ouven</strong></p>
	</header>
</div>
<div class="wrapper">



<div class="post-meta">
	<div class="post-date">2015年11月29日</div>
	<div class="post-categories">
	 in  
		<a target="_blank" href="/category/?cate=frontend-javascript">Frontend-javascript</a>
	  
	</div>
</div>	

<article class="post-content">
  <h3 id="section">前端数据的双向绑定方法</h3>

<p>  前端的视图层和数据层有时需要实现双向绑定(two-way-binding)，例如mvvm框架，数据驱动视图，视图状态机等，研究了几个目前主流的数据双向绑定框架，总结了下。目前实现数据双向绑定主要有以下三种。</p>

<p><a href="https://github.com/ouvens/demo-file/tree/master/two-ways-binding">github演示例子</a></p>

<h4 id="section-1">1、手动绑定</h4>
<p>比较老的实现方式，有点像观察者编程模式，主要思路是通过在数据对象上定义get和set方法(当然还有其它方法)，调用时手动调用get或set数据，改变数据后出发UI层的渲染操作；以视图驱动数据变化的场景主要应用与input、select、textarea等元素，当UI层变化时，通过监听dom的change，keypress，keyup等事件来出发事件改变数据层的数据。整个过程均通过函数调用完成。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>data-binding-method-set<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">q-value=</span><span class="s">"value"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"input"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">q-text=</span><span class="s">"value"</span> <span class="na">id=</span><span class="s">"el"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">var</span> <span class="nx">elems</span> <span class="o">=</span> <span class="p">[</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'el'</span><span class="p">),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)];</span>

        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">value</span><span class="p">:</span> <span class="s1">'hello!'</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">command</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">text</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="na">value</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">scan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>        
            <span class="cm">/**
             * 扫描带指令的节点属性
             */</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len1</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">len1</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'q-'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="cm">/**
                         * 调用属性指令，这里可以使用数据改变检测
                         */</span>
                        <span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)].</span><span class="nx">call</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">]);</span>
                        <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/**
         * 设置数据后扫描
         */</span>
        <span class="kd">function</span> <span class="nx">mvSet</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
            <span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="nx">scan</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="cm">/**
         * 数据绑定监听
         */</span>
        <span class="nx">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'keyup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
            <span class="nx">mvSet</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

        <span class="nx">scan</span><span class="p">();</span>

        <span class="cm">/**
         * 改变数据更新视图
         */</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">mvSet</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="s1">'fuck'</span><span class="p">);</span>
        <span class="p">},</span><span class="mi">1000</span><span class="p">)</span>

    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="section-2">2、脏检查机制</h4>

<p>  以典型的mvvm框架angularjs为代表，angular通过检查脏数据来进行UI层的操作更新。关于angular的脏检测，有几点需要了解些：
- 脏检测机制并不是使用定时检测。
- 脏检测的时机是在数据发生变化时进行。
- angular对常用的dom事件，xhr事件等做了封装， 在里面触发进入angular的digest流程。
- 在digest流程里面， 会从rootscope开始遍历， 检查所有的watcher。
（关于angular的具体设计可以看其他文档，这里只讨论数据绑定），那我们看下脏检测该如何去做：主要是通过设置的数据来需找与该数据相关的所有元素，然后再比较数据变化，如果变化则进行指令操作</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>data-binding-drity-check<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">q-event=</span><span class="s">"value"</span> <span class="na">ng-bind=</span><span class="s">"value"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"input"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">q-event=</span><span class="s">"text"</span> <span class="na">ng-bind=</span><span class="s">"value"</span> <span class="na">id=</span><span class="s">"el"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>

    <span class="kd">var</span> <span class="nx">elems</span> <span class="o">=</span> <span class="p">[</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'el'</span><span class="p">),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)];</span>
    
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">value</span><span class="p">:</span> <span class="s1">'hello!'</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">command</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">text</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">value</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">scan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elems</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/**
         * 扫描带指令的节点属性
         */</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len1</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">len1</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'q-event'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/**
                     * 调用属性指令
                     */</span>
                    <span class="kd">var</span> <span class="nx">dataKey</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'ng-bind'</span><span class="p">)</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;</span>
                    <span class="cm">/**
                     * 进行数据初始化
                     */</span>
                    <span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dataKey</span><span class="p">]);</span>
                    <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dataKey</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
     * 脏循环检测
     * @param  {[type]} elems [description]
     * @return {[type]}       [description]
     */</span>
    <span class="kd">var</span> <span class="nx">digest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elems</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/**
         * 扫描带指令的节点属性
         */</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len1</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">len1</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'q-event'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/**
                     * 调用属性指令
                     */</span>
                    <span class="kd">var</span> <span class="nx">dataKey</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'ng-bind'</span><span class="p">)</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;</span>

                    <span class="cm">/**
                     * 进行脏数据检测，如果数据改变，则重新执行指令，否则跳过
                     */</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dataKey</span><span class="p">]){</span>

                        <span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dataKey</span><span class="p">]);</span>
                        <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">dataKey</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
     * 初始化数据
     */</span>
    <span class="nx">scan</span><span class="p">(</span><span class="nx">elems</span><span class="p">);</span>

    <span class="cm">/**
     * 可以理解为做数据劫持监听
     */</span>
    <span class="kd">function</span> <span class="nx">$digest</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'[ng-bind='</span><span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s1">']'</span><span class="p">);</span>
        <span class="nx">digest</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**
     * 输入框数据绑定监听
     */</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">){</span>
        <span class="nx">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'keyup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
            <span class="nx">$digest</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'ng-bind'</span><span class="p">));</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">'onkeyup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
            <span class="nx">$digest</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'ng-bind'</span><span class="p">));</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">'fuck'</span><span class="p">;</span>
        <span class="cm">/**
         * 这里问啥还要执行$digest这里关键的是需要手动调用$digest方法来启动脏检测
         */</span>
        <span class="nx">$digest</span><span class="p">(</span><span class="s1">'value'</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>

    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="hijacking">3、前端数据劫持(Hijacking)</h4>

<p>  第三种方法则是avalon等框架使用的数据劫持方式。基本思路是使用Object.defineProperty对数据对象做属性get和set的监听，当有数据读取和赋值操作时则调用节点的指令，这样使用最通用的=等号赋值就可以了。具体实现如下：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>data-binding-hijacking<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">q-value=</span><span class="s">"value"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"input"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">q-text=</span><span class="s">"value"</span> <span class="na">id=</span><span class="s">"el"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>


    <span class="kd">var</span> <span class="nx">elems</span> <span class="o">=</span> <span class="p">[</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'el'</span><span class="p">),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)];</span>

    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">value</span><span class="p">:</span> <span class="s1">'hello!'</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">command</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">text</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">value</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">scan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="cm">/**
         * 扫描带指令的节点属性
         */</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">elems</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len1</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">len1</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'q-'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/**
                     * 调用属性指令
                     */</span>
                    <span class="nx">command</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)].</span><span class="nx">call</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">]);</span>
                    <span class="nx">elem</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">bValue</span><span class="p">;</span>
    <span class="cm">/**
     * 定义属性设置劫持
     */</span>
    <span class="kd">var</span> <span class="nx">defineGetAndSet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">propName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">propName</span><span class="p">,</span> <span class="p">{</span>

                <span class="na">get</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">bValue</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="na">set</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">bValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
                    <span class="nx">scan</span><span class="p">();</span>
                <span class="p">},</span>

                <span class="na">enumerable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="na">configurable</span><span class="p">:</span> <span class="kc">true</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"browser not supported."</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/**
     * 初始化数据
     */</span>
    <span class="nx">scan</span><span class="p">();</span>

    <span class="cm">/**
     * 可以理解为做数据劫持监听
     */</span>
    <span class="nx">defineGetAndSet</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">);</span>

    <span class="cm">/**
     * 数据绑定监听
     */</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">){</span>
        <span class="nx">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'keyup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">'onkeyup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">'fuck'</span><span class="p">;</span>
    <span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>  但值得注意的是defineProperty支持IE8以上的浏览器，这里可以使用__<strong>defineGetter</strong>__ 和 <strong>__defineSetter</strong>__ 来做兼容但是浏览器兼容性的原因，直接用defineProperty就可以了。至于IE8浏览器仍需要使用其它方法来做hack。如下代码可以对IE8进行hack，defineProperty支持IE8。例如使用es5-shim.js就可以了。（IE8以下浏览器忽略）</p>

<h4 id="section-3">4、小结</h4>
<p>  首先这里的例子只是简单的实现，读者可以深入感受三种方式的异同点，复杂的框架也是通过这样的基本思路滚雪球滚大的。</p>

<p><a href="https://github.com/ouvens/demo-file/tree/master/two-ways-binding">演示例子</a></p>

<p>参考：</p>

<p>https://gist.github.com/brettz9/4093766#file_html5_dataset.js
https://github.com/xufei/blog/issues/10</p>

</article>


<div class="tags">
	<strong>Tags:</strong> <a target="_blank" href="/tags/?tag=javascript">javascript</a>,&nbsp;<a target="_blank" href="/tags/?tag=数据双向绑定">数据双向绑定</a>,&nbsp;<a target="_blank" href="/tags/?tag=mvvm">mvvm</a>
</div>


	<script src="/assets/js/github.comment.js"></script>
	<div class="gc-comments" data-repos="ouvens/ouvens.github.io" data-issues="3" >
	    <div class="gc-comments-title">
	        评论
	    </div>
	    <div class="gc-comments-info">
	        想在此留下评论，请访问 <a href="issues_link">issues_link</a> 提交评论
	    </div>
	</div>
</div>
</div>


    </div>
    
<div class="qr-code qr-code-pay" title="加个微信交流交流">
    <img src="/assets/qrcode/qr-code-person.jpg" width="200" height="200" alt="公众号">
    <p>加我赏红包，哈哈哈</p>
</div>

<div class="qr-code qr-code-wx" title="定期获取更新动态">
    <img src="/assets/qrcode/qrcode.jpg" width="200" height="200" alt="公众号">
    <p>欢迎关注 <strong>极限前端</strong> 公众号</p>
</div>


    
<footer class="site-footer">
  <div class="wrapper">
    <h3 class="footer-heading">极限前端</h3>
    <div class="site-navigation">
    	<p><strong>站内</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">关于</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/category/">所有文章</a>
        
        
        
          <li class="nav-link"><a href="/tags/">标签分类</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>
    <div class="site-contact">
    	<p><strong>相关链接</strong></p>
        <ul class="social-media-list">
      	<li>
      		<a href="mailto:1025224452@qq.com">
	      		<i class="icon-font i-star"></i>
	      		<span class="username">1025224452@qq.com</span>
      		</a>
      	</li>

      	
	      	
	      	<li>
	           <a href="https://github.com/ouvens" title="Fork me on GitHub">
	               <i class="icon-font i-heart"></i>
	               <span class="username">ouvens</span>
	           </a>
	        </li>
	      	
      	

      </ul>
    </div>
    <div class="site-signature">
    	<p class="rss-subscribe text"><strong>订阅<a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">极限前端, 极限前端社区, ouven的博客, ouvenzhang的博客, www.jixianqianduan.com, github地址, 前端技术, 讲述前端高效技术与前沿。</p>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="//1.url.cn/jslib/jquery/1.9.1/jquery.min.js" defer></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js" defer></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" defer></script>

<script src="/assets/js/main.js" defer></script>

    </body>
</html>
