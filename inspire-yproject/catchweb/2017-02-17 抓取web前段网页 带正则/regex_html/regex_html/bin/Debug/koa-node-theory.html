<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="0FNbiBWk1FugWYo-RiGxQyIHebGeLoXp3HB7AxIFKy8" />
    <meta name="baidu-site-verification" content="tYoUqpkCCv" />
    <meta name="baidu-site-verification" content="IGN97NW90O" />
    
    <title>Koa框架实践与中间件原理剖析 | ouvenzhang的博客</title>

    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <link rel="dns-prefetch" href="cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="1.url.cn" />

    <meta name="description" itemprop="description" content="Koa框架实践与中间件原理剖析,koa,原理 ">
    <meta itemprop="name" content="Koa框架实践与中间件原理剖析">
    <meta itemprop="image" content="http://ouvens.github.io/blog/assets/logo.png">
    <meta itemprop="keywords" name="keywords" content="Koa框架实践与中间件原理剖析,koa,原理 ">

    
    <meta name="author" content="ouvenzhang">
    <meta name="copyright" content="&copy; ouvenzhang 2017">
    <meta name="protocol" content="1">
    

    <!-- External libraries -->
    <link rel="stylesheet" href="/assets/css/iconfont.css">
    <link rel="stylesheet" href="/css/monokai_sublime.css">

    <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  	<link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
  	<meta name="msapplication-TileColor" content="#ffffff">
  	<meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icons/icon.png">

  	<!-- Site styles -->
    <link rel="stylesheet" href="/css/main.css">

    <link rel="alternate" type="application/rss+xml" title="极限前端" href="http://ouvens.github.io//feed.xml" />
    <script>
    // 访问统计
    var domain = 'jixianqianduan.com';
    var oldDomain = 'ouvens.github.io';
    if(location.host === domain){
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?b536b128dc21c3d18fdc028f0609e3f0";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }else if(location.host === oldDomain){
        window.location.href = location.href.replace(oldDomain, domain);
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?041efd2cb345ca1b9dbdbb2383cb716d";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }

    // 链接提交

    if(location.protocol === 'https'){
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,t=document.referrer;if(!e.test(r)){var o="https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif";t?(o+="?r="+encodeURIComponent(document.referrer),r&&(o+="&l="+r)):r&&(o+="?l="+r);var i=new Image;i.src=o}}(window);
    }else{
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
    }


    </script>
</head>

    <body>
        <div class="navigation" role="banner">
    <div class="navigation-wrapper">
    <a href="/" class="logo">
    	
      <img src="/assets/logo.png" alt="极限前端">
      
    </a>
    <span class="search-input" id="search-input">
      <input type="text" value="" class="search-text" placeholder="输入搜索关键字">
      <i class="icon-font i-search search-btn"></i>
    </span>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
    	<i class="icon-font i-list fa fa-bars"></i>
    </a>
    <span class="nav" role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
      	
          
          <li class="nav-link">
            <a href="/about/">关于</a>
          </li>
          
        
          
        
          
        
          
        
          
          <li class="nav-link">
            <a href="/category/">所有文章</a>
          </li>
          
        
          
          <li class="nav-link">
            <a href="/tags/">标签分类</a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          <li id="github-info" class="nav-link" title="https://github.com/ouvens">
            <a class="github-info" href="https://github.com/ouvens" target="_blank">
            <img src="/assets/github.png" height="34" width="130" alt="github地址"></a>
          </li>
      </ul>
    </span>
  </div>
</div>

            <div class="page-content">
        <div class="post">
<div class="post-header-container has-cover">
	<header class="post-header">
	  <h1 class="title">Koa框架实践与中间件原理剖析</h1>
	  <p class="info">by <strong>ouven</strong></p>
	</header>
</div>
<div class="wrapper">



<div class="post-meta">
	<div class="post-date">2015年12月19日</div>
	<div class="post-categories">
	 in  
		<a target="_blank" href="/category/?cate=frontend-javascript">Frontend-javascript</a>
	  
	</div>
</div>	

<article class="post-content">
  <p>  [转载]：<a href="http://www.cnblogs.com/Leo_wl/p/4684633.html">http://www.cnblogs.com/Leo_wl/p/4684633.html</a>。本文写的很深刻易懂，转来收藏。</p>

<p>  Koa是Express原班人马打造的一个更小，基于nodejs平台的下一代web开发框架。Koa的精妙之处就在于其使用generator和promise，实现了一种更为有趣的中间件系统，Koa的中间件是一系列generator函数的对象，执行起来有点类似于栈的结构，依次执行。同时也类似于Python的django框架的中间件系统，以前苏千大神做分享的时候把这种模型称作为洋葱模型。</p>

<p>  当一个请求过来的时候，会依次经过各个中间件进行处理，中间件跳转的信号是yield next，当到某个中间件后，该中间件处理完不执行yield next的时候，然后就会逆序执行前面那些中间件剩下的逻辑。直接上个官网的例子：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>

<span class="c1">// response-time中间件</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'X-Response-Time'</span><span class="p">,</span> <span class="nx">ms</span> <span class="o">+</span> <span class="s1">'ms'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// logger中间件</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'%s %s - %s'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 响应中间件</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'Hello World'</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  上面的执行顺序就是：请求 ==&gt; response-time中间件 ==&gt; logger中间件 ==&gt; 响应中间件 ==&gt; logger中间件 ==&gt; response-time中间件 ==&gt; 响应。</p>

<p>  更详细描述就是：请求进来，先进到response-time中间件，执行 var start = new Date; 然后遇到yield next，则暂停response-time中间件的执行，跳转进logger中间件，同理，最后进入响应中间件，响应中间件中没有yield next代码，则开始逆序执行，也就是再先是回到logger中间件，执行yield next之后的代码，执行完后再回到response-time中间件执行yield next之后的代码。</p>

<p>  至此，整个Koa的中间件执行完毕 ，整个中间件执行过程相当有意思。而Koa的中间件是运行在 co 函数下的，而tj大神的co函数能够把异步变同步，也就说，编写Koa的中间件的时候可以这样写，就拿上面那个demo最后的响应中间件来说可以改成这样：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">'./index.html'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  通过Promise可以把获取的文件数据data通过resolve函数，传到最外层的text中，而且，整个异步操作变成了同步操作。再比如使用mongodb做一个数据库查询功能，就可以写成这样，整个数据的查询原来是异步操作，也可以变成了同步，因为mongodb官方驱动的接口提供了返回Promise的功能，在co函数里只用yield的时候能够直接把异步变成同步，再也不用写那恶心的回调嵌套了。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">MongoClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongodb"</span><span class="p">).</span><span class="nx">MongoClient</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'mongodb://127.0.0.1:27017/myblog'</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'document'</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">();</span>
    
    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  tj的co函数就如同一个魔法，把所有异步都变成了同步，看起来好像很高大上。但是co函数做的事其实并不复杂。整个co函数说白了，就是使用Promise递归调用generator的next方法，并且在后一次调用的时候把前一次返回的数据传入，直到调用完毕。而co函数同时把非Promise对象的function、generator、array等也组装成了Promise对象。所以可以在yield后面不仅仅可以接Promise，还可以接generator对象等。</p>

<p>  自己实现了一个简单的co函数，传入一个generator，获取generator的函数对象，然后定义一个next方法用于递归，在next方法里执行generator.next()并且传入data，执行完generator.next()会获取到{value:XX, done: true}的对象，如果done为true，说明generator已经迭代完毕，退出。否则，假设当前执行到yield new Promise()，也就是返回的result.value就是Promise对象的，直接执行Promise的then方法，并且在then方法的onFulfilled回调（也就是Promise中的异步执行完毕后，调用resolve的时候会触发该回调函数）中执行next方法进行递归，并且将onFulfilled中传入的数据传入next方法，也就可以在下一次generator.next()中把数据传进去。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre>
<span class="c1">// co简易实现</span>
<span class="kd">function</span> <span class="nx">co</span><span class="p">(</span><span class="nx">generator</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">generator</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Promise</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">next</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
            <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">})</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>  写个demo测试一下：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="c1">// test</span>
<span class="nx">co</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">text1</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="s2">"I am text1"</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text1</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">text2</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="s2">"I am text2"</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text2</span><span class="p">);</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  既然了解了co函数的原理，再来说说koa的中间件是怎么实现的。整个实现原理就是把所有generator放到一个数组里保存，然后对所有generator进行相应的链式调用。</p>

<p>  起初是自己按照自己的想法实现了一次，大概原理如下：</p>

<p>  用个数组，在每次执行use方法的时候把generator传入gens数组保存，然后在执行的时候，先定义一个generator的执行索引index、跳转标记ne（也就是yield next里的next）、还有一个是用于保存generator函数对象的数组gs，。然后获取当前中间件generator，并且获取到该generator的函数对象，将函数对象放入gs数组中保存，再执行generator.next()。</p>

<p>  接着根据返回的value，做不同处理，如果是Promise，则跟上面的co函数一样，在其onFulfilled的回调中执行下一次generator.next()，如果是ne，也就是当前执行到了yield next，说明要跳转到下一个中间件，此时对index++，然后从gens数组里获取下一个中间件重复上一个中间件的操作。</p>

<p>  当执行到的中间件里没有yield next时，并且当该generator已经执行完毕，也就是返回的done为true的时候，再逆序执行，从此前用于保存generator的函数对象gs数组获取到上一个generator函数对象，然后执行该generator的next方法。直到全部执行完毕。</p>

<p>  整个过程就像，先是入栈，然后出栈的操作。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">gens</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">function</span> <span class="nx">use</span><span class="p">(</span><span class="nx">generetor</span><span class="p">){</span>
    <span class="nx">gens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">generetor</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">trigger</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ne</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">gs</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">g</span><span class="p">;</span>

    <span class="nx">next</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">next</span><span class="p">(){</span>
        <span class="c1">//获取当前中间件，传入next标记，即当yield next时处理下一个中间件</span>
        <span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">gens</span><span class="p">[</span><span class="nx">index</span><span class="p">](</span><span class="nx">ne</span><span class="p">);</span>

        <span class="c1">//保存实例化的中间件</span>
        <span class="nx">gs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gen</span><span class="p">);</span>

        <span class="nx">co</span><span class="p">(</span><span class="nx">gen</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">co</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">gen</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="c1">// 当当前的generator中间件执行完毕，将执行索引减一，获取上一级的中间件并且执行</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">){</span>
            <span class="nx">index</span><span class="o">--</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">gs</span><span class="p">[</span><span class="nx">index</span><span class="p">]){</span>
                <span class="nx">co</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 如果执行到Promise，则当Promise执行完毕再进行递归</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Promise</span><span class="p">){</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                <span class="nx">co</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="p">})</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">ne</span><span class="p">){</span>
            <span class="c1">// 当遇到yield next时，执行下一个中间件</span>
            <span class="nx">index</span><span class="o">++</span><span class="p">;</span>

            <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">co</span><span class="p">(</span><span class="nx">gen</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  然后再写个demo测试一下：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></td><td class="code"><pre><span class="c1">// test</span>

<span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="s2">"step1"</span><span class="p">)</span>
        <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>

    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"step2"</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"step3"</span><span class="p">);</span>

    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="s2">"step4"</span><span class="p">)</span>
        <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="s2">"step5"</span><span class="p">)</span>
        <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"step6"</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">trigger</span><span class="p">();</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  上面的只是我自己的觉得的实现原理，但是其实koa自己的实现更精简，在看了koa的源码后，也大概实现了一下，其实就是把上面的那个co函数进行适当改造一下，然后用个while循环，把所有generator链式绑定起来，再放到co函数里进行yield即可。下面贴出源码：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">gens</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">function</span> <span class="nx">use</span><span class="p">(</span><span class="nx">generetor</span><span class="p">){</span>
    <span class="nx">gens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">generetor</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 实现co函数</span>
<span class="kd">function</span> <span class="nx">co</span><span class="p">(</span><span class="nx">flow</span><span class="p">,</span> <span class="nx">isGenerator</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">gen</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isGenerator</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gen</span> <span class="o">=</span> <span class="nx">flow</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">gen</span> <span class="o">=</span> <span class="nx">flow</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

            <span class="c1">// 如果调用完毕，调用resolve</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">){</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 如果为yield后面接的为generator，传入co进行递归，并且将promise返回</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">next</span> <span class="o">===</span> <span class="s2">"function"</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="k">throw</span> <span class="o">===</span> <span class="s2">"function"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="nx">co</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">){</span>
                <span class="c1">// 当promise执行完毕，调用next处理下一个yield</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                    <span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">trigger</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">gens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">co</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
        <span class="k">while</span><span class="p">(</span><span class="nx">m</span><span class="o">--</span><span class="p">){</span>
            <span class="c1">// 形成链式generator</span>
            <span class="nx">prev</span> <span class="o">=</span> <span class="nx">gens</span><span class="p">[</span><span class="nx">m</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// 执行最外层generator方法</span>
        <span class="k">yield</span> <span class="nx">prev</span><span class="p">;</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  执行结果也是无问题，运行demo和运行结果跟上一个一样，就不贴出来了。</p>

</article>


<div class="tags">
	<strong>Tags:</strong> <a target="_blank" href="/tags/?tag=koa">koa</a>,&nbsp;<a target="_blank" href="/tags/?tag=原理">原理</a>
</div>


	<script src="/assets/js/github.comment.js"></script>
	<div class="gc-comments" data-repos="ouvens/ouvens.github.io" data-issues="3" >
	    <div class="gc-comments-title">
	        评论
	    </div>
	    <div class="gc-comments-info">
	        想在此留下评论，请访问 <a href="issues_link">issues_link</a> 提交评论
	    </div>
	</div>
</div>
</div>


    </div>
    
<div class="qr-code qr-code-pay" title="加个微信交流交流">
    <img src="/assets/qrcode/qr-code-person.jpg" width="200" height="200" alt="公众号">
    <p>加我赏红包，哈哈哈</p>
</div>

<div class="qr-code qr-code-wx" title="定期获取更新动态">
    <img src="/assets/qrcode/qrcode.jpg" width="200" height="200" alt="公众号">
    <p>欢迎关注 <strong>极限前端</strong> 公众号</p>
</div>


    
<footer class="site-footer">
  <div class="wrapper">
    <h3 class="footer-heading">极限前端</h3>
    <div class="site-navigation">
    	<p><strong>站内</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">关于</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/category/">所有文章</a>
        
        
        
          <li class="nav-link"><a href="/tags/">标签分类</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>
    <div class="site-contact">
    	<p><strong>相关链接</strong></p>
        <ul class="social-media-list">
      	<li>
      		<a href="mailto:1025224452@qq.com">
	      		<i class="icon-font i-star"></i>
	      		<span class="username">1025224452@qq.com</span>
      		</a>
      	</li>

      	
	      	
	      	<li>
	           <a href="https://github.com/ouvens" title="Fork me on GitHub">
	               <i class="icon-font i-heart"></i>
	               <span class="username">ouvens</span>
	           </a>
	        </li>
	      	
      	

      </ul>
    </div>
    <div class="site-signature">
    	<p class="rss-subscribe text"><strong>订阅<a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">极限前端, 极限前端社区, ouven的博客, ouvenzhang的博客, www.jixianqianduan.com, github地址, 前端技术, 讲述前端高效技术与前沿。</p>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="//1.url.cn/jslib/jquery/1.9.1/jquery.min.js" defer></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js" defer></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" defer></script>

<script src="/assets/js/main.js" defer></script>

    </body>
</html>
