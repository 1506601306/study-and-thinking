<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="0FNbiBWk1FugWYo-RiGxQyIHebGeLoXp3HB7AxIFKy8" />
    <meta name="baidu-site-verification" content="tYoUqpkCCv" />
    <meta name="baidu-site-verification" content="IGN97NW90O" />
    
    <title>下一代前端打包工具与tree-shaking | ouvenzhang的博客</title>

    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <link rel="dns-prefetch" href="cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="1.url.cn" />

    <meta name="description" itemprop="description" content="下一代前端打包工具与tree-shaking,打包工具,rollup,webpack2,tree-shaking ">
    <meta itemprop="name" content="下一代前端打包工具与tree-shaking">
    <meta itemprop="image" content="http://ouvens.github.io/blog/assets/logo.png">
    <meta itemprop="keywords" name="keywords" content="下一代前端打包工具与tree-shaking,打包工具,rollup,webpack2,tree-shaking ">

    
    <meta name="author" content="ouvenzhang">
    <meta name="copyright" content="&copy; ouvenzhang 2017">
    <meta name="protocol" content="1">
    

    <!-- External libraries -->
    <link rel="stylesheet" href="/assets/css/iconfont.css">
    <link rel="stylesheet" href="/css/monokai_sublime.css">

    <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  	<link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
  	<meta name="msapplication-TileColor" content="#ffffff">
  	<meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icons/icon.png">

  	<!-- Site styles -->
    <link rel="stylesheet" href="/css/main.css">

    <link rel="alternate" type="application/rss+xml" title="极限前端" href="http://ouvens.github.io//feed.xml" />
    <script>
    // 访问统计
    var domain = 'jixianqianduan.com';
    var oldDomain = 'ouvens.github.io';
    if(location.host === domain){
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?b536b128dc21c3d18fdc028f0609e3f0";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }else if(location.host === oldDomain){
        window.location.href = location.href.replace(oldDomain, domain);
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?041efd2cb345ca1b9dbdbb2383cb716d";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }

    // 链接提交

    if(location.protocol === 'https'){
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,t=document.referrer;if(!e.test(r)){var o="https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif";t?(o+="?r="+encodeURIComponent(document.referrer),r&&(o+="&l="+r)):r&&(o+="?l="+r);var i=new Image;i.src=o}}(window);
    }else{
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
    }


    </script>
</head>

    <body>
        <div class="navigation" role="banner">
    <div class="navigation-wrapper">
    <a href="/" class="logo">
    	
      <img src="/assets/logo.png" alt="极限前端">
      
    </a>
    <span class="search-input" id="search-input">
      <input type="text" value="" class="search-text" placeholder="输入搜索关键字">
      <i class="icon-font i-search search-btn"></i>
    </span>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
    	<i class="icon-font i-list fa fa-bars"></i>
    </a>
    <span class="nav" role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
      	
          
          <li class="nav-link">
            <a href="/about/">关于</a>
          </li>
          
        
          
        
          
        
          
        
          
          <li class="nav-link">
            <a href="/category/">所有文章</a>
          </li>
          
        
          
          <li class="nav-link">
            <a href="/tags/">标签分类</a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          <li id="github-info" class="nav-link" title="https://github.com/ouvens">
            <a class="github-info" href="https://github.com/ouvens" target="_blank">
            <img src="/assets/github.png" height="34" width="130" alt="github地址"></a>
          </li>
      </ul>
    </span>
  </div>
</div>

            <div class="page-content">
        <div class="post">
<div class="post-header-container has-cover">
	<header class="post-header">
	  <h1 class="title">下一代前端打包工具与tree-shaking</h1>
	  <p class="info">by <strong>ouven</strong></p>
	</header>
</div>
<div class="wrapper">



<div class="post-meta">
	<div class="post-date">2016年01月20日</div>
	<div class="post-categories">
	 in  
		<a target="_blank" href="/category/?cate=frontend-build">Frontend-build</a>
	  
	</div>
</div>	

<article class="post-content">
  <h2 id="js">一、js模块化打包概述</h2>
<p>  随着js模块化规范AMD、CMD、commonJs的出现，模块打包工具也在不断的出现和演变，依次出现了r.js、browserify和webpack，过去的2015年就是webpack大行其道的一年，又随着reactjs、es6的出现，webpack更是深入人心，因为其人性化的特点和友好性，确实给前端模块打包带来了极大的方便。
  不过今天并不是重点讲webpack，而是rollup，要了解webpack，可以看我的另一篇文章：http://ouvens.github.io/frontend-build/2015/04/01/webpack-tool.html ，在讲rollup之前先来看看几种之前的前端打包方案。</p>

<h2 id="js-1">二、js模块化打包方案</h2>
<p>  先区分下几个不同概念：包管理工具（package manager）、模块加载器（module loader），打包工具（bundler），包管理器指管理安装js模块的这类，例如npm、bower、jspm这些，模块加载器指向requirejs、modjs、seajs这些，模块加载器又主要遵循AMD、CMD、Commonjs三种规范，打包工具则指r.js、browserify、webpack这类。</p>

<h4 id="rjs">1、r.js</h4>
<p>  在grunt结合requirejs的年代，r.js作为通用标配的打包工具普世存在，当然现在应该也有些团队在用。
  r.js是requireJS的优化（Optimizer）工具，可以实现前端文件的压缩与合并，在requireJS异步按需加载的基础上进一步提供前端优化，减小前端文件大小、减少对服务器的文件请求。先来分析一个官网的例子：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre>
<span class="p">{</span>
    <span class="nl">appDir</span><span class="p">:</span> <span class="s1">'../www'</span><span class="p">,</span>
    <span class="nx">baseUrl</span><span class="err">:</span> <span class="s1">'js/lib'</span><span class="p">,</span>
    <span class="nx">paths</span><span class="err">:</span> <span class="p">{</span>
        <span class="nl">app</span><span class="p">:</span> <span class="s1">'../app'</span>
    <span class="p">},</span>
    <span class="nx">dir</span><span class="err">:</span> <span class="s1">'../www-built'</span><span class="p">,</span>
    <span class="nx">modules</span><span class="err">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="c1">//module names are relative to baseUrl</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'../common'</span><span class="p">,</span>
            <span class="na">include</span><span class="p">:</span> <span class="p">[</span><span class="s1">'jquery'</span><span class="p">,</span>
                      <span class="s1">'app/lib'</span><span class="p">,</span>
                      <span class="s1">'app/controller/Base'</span><span class="p">,</span>
                      <span class="s1">'app/model/Base'</span>
            <span class="p">]</span>
        <span class="p">},{</span>
          <span class="c1">//module names are relative to baseUrl/paths config</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'../page1'</span><span class="p">,</span>
            <span class="na">include</span><span class="p">:</span> <span class="p">[</span><span class="s1">'app/main1'</span><span class="p">],</span>
            <span class="na">exclude</span><span class="p">:</span> <span class="p">[</span><span class="s1">'../common'</span><span class="p">]</span>
        <span class="p">},{</span>
            <span class="c1">//module names are relative to baseUrl</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'../page2'</span><span class="p">,</span>
            <span class="na">include</span><span class="p">:</span> <span class="p">[</span><span class="s1">'app/main2'</span><span class="p">],</span>
            <span class="na">exclude</span><span class="p">:</span> <span class="p">[</span><span class="s1">'../common'</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>如果这个文件配置命名为build.js，在node环境下执行 node r.js -o build.js 就可以压缩合并需要的模块。可以见一下配置
<img src="http://7tszky.com1.z0.glb.clouddn.com/FucZNwVKdE_sh8BDZy29SA5SP1pf" alt="" />
地址见：https://github.com/requirejs/example-multipage/blob/master/tools/build.js</p>

<p>  这里通过相对路径和baseUrl路径来进行文件依赖查找，所以一般我们会设置一个baseUrl来指定要打包的js目录，并将多个文件合成一个文件，并存放到指定的目录下面。简单的理解，他就是一个简单的js依赖分析合并工具。那我们来总结下它的特点：</p>

<ul>
  <li>可以合并js，css，并结合其它工具压缩，甚至对整个项目进行打包</li>
  <li>一般需要指定baseUrl</li>
  <li>需要将r.js放到开发目录中</li>
  <li>依赖requireJs的AMD规范，CMD和CommonJs的场景不适用</li>
  <li>需要手写配置</li>
</ul>

<h4 id="browserify">2、browserify</h4>
<p>  Browserify 可以让你使用类似于 node 的 require() 的方式来组织浏览器端的 Javascript 代码，不需要 define(function(require, exports, module) {…}) ，更符合CommonJS模块化规范，并且可以让前端 Javascript模块直接使用npm install的方式安装模块。browserify使用Esprima解析依赖， 生成的AST兼容Mozilla规范。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">g</span> <span class="nx">browserify</span>
<span class="nx">browserify</span> <span class="nx">greet</span><span class="p">.</span><span class="nx">js</span> <span class="o">&gt;</span> <span class="nx">bundle</span><span class="p">.</span><span class="nx">js</span> <span class="c1">//把 greet.js 及其所依赖的模块文件打包成单个 bundle.js 文件。</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>看一个完整的例子：
<strong>配置的js文件</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">domify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'domify'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">insertCss</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'insert-css'</span><span class="p">);</span>
 
<span class="kd">var</span> <span class="nx">css</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/badge.css'</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">);</span>
<span class="nx">insertCss</span><span class="p">(</span><span class="nx">css</span><span class="p">);</span>
 
<span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/badge.html'</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">);</span>
 
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Badge</span><span class="p">;</span>
 
<span class="kd">function</span> <span class="nx">Badge</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Badge</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Badge</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">domify</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setNumber</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">number</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="nx">Badge</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setNumber</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.number'</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nx">Badge</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appendTo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="nx">target</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
  <span class="nx">target</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">);</span>
<span class="p">};</span>
</pre></td></tr></tbody></table>
</div>
</div>
<p><strong>package.json</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="p">{</span>
  <span class="s2">"name"</span><span class="err">:</span> <span class="s2">"badge"</span><span class="p">,</span>
  <span class="s2">"version"</span><span class="err">:</span> <span class="s2">"1.0.0"</span><span class="p">,</span>
  <span class="s2">"private"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">"main"</span><span class="err">:</span> <span class="s2">"badge.js"</span><span class="p">,</span>
  <span class="s2">"browserify"</span><span class="err">:</span> <span class="p">{</span>
  <span class="s2">"transform"</span><span class="err">:</span> <span class="p">[</span> <span class="s2">"brfs"</span> <span class="p">]</span>
<span class="p">},</span>
<span class="s2">"dependencies"</span><span class="err">:</span> <span class="p">{</span>
  <span class="s2">"brfs"</span><span class="err">:</span> <span class="s2">"^1.1.1"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>
<p>除了配置，我们不得不管理一个依赖包的映射表，即package.json文件，这样才能正常使用自定义的模块</p>

<p>可见：
- browserify更多是为了支持commonJs的规范
- 可以让前端 Javascript模块直接使用npm install的方式安装
- 使用机制稍微复杂，开发者需要关心的东西很多
- 需要手写打包配置和任务</p>

<h4 id="webpack">3、webpack</h4>
<p>  webpack之前也讲到过http://ouvens.github.io/frontend-build/2015/04/01/webpack-tool.html 。这里就直接总结一下webpack的特点：</p>

<ul>
  <li>模块来源广泛，支持包括npm/bower等等的各种主流模块安装／依赖解决方案</li>
  <li>模块规范支持全面，amd/cmd/commonjs/shimming等完全支持</li>
  <li>浏览器端足迹小，移动端友好，却对热加载乃至热替换有很好的支持</li>
  <li>插件机制完善，实现本身实现同样模块化，容易扩展，支持es6，react等</li>
  <li>需要手写配置</li>
</ul>

<p>  对于这里对多种模块规范的支持，这里讲下webpack是怎么封装定义的，例如这里是一个cookie的操作库：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">'function'</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">define</span><span class="p">([</span><span class="s1">'zepto'</span><span class="p">],</span> <span class="nx">factory</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">'object'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">'zepto'</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">[</span><span class="s1">'Cookie'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">root</span><span class="p">[</span><span class="s1">'Zepto'</span><span class="p">]);</span>
    <span class="p">}</span>

<span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">init</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(){</span>

    <span class="p">}</span>
  <span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">exports</span><span class="p">;</span>
<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>相信大家一看就懂，对于webpack的配置文件写起来也是很长简洁，这就是为什么webpack目前这么受欢迎的原因之一。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre>
 <span class="c1">// webpack.config.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">entry</span><span class="p">:</span> <span class="s1">'./main.js'</span><span class="p">,</span>
  <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'bundle.js'</span>       
  <span class="p">}</span>
<span class="p">};</span>
<span class="err">当然也可以这样，</span><span class="nx">webpack</span><span class="err">支持了</span><span class="nx">coffee</span><span class="err">和</span><span class="nx">jsx</span><span class="err">，喜欢玩</span><span class="nx">react</span><span class="err">的同学可以试下。</span>
<span class="c1">// webpack.config.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">entry</span><span class="p">:</span> <span class="s1">'./main.js'</span><span class="p">,</span>
  <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'bundle.js'</span>       
  <span class="p">},</span>
  <span class="na">module</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">loaders</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">test</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">coffee$/</span><span class="p">,</span> <span class="na">loader</span><span class="p">:</span> <span class="s1">'coffee-loader'</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">test</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">js$/</span><span class="p">,</span> <span class="na">loader</span><span class="p">:</span> <span class="s1">'jsx-loader?harmony'</span> <span class="p">}</span> <span class="c1">// loaders can take parameters as a querystring</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="fis3-packager-loader">4、fis3-packager-loader</h4>
<p>  fis3-packager-loader(后面简称fpl)一般没有单独拿出来讲，因为这个是结合fis3一起使用的，fis3的单文件进行处理的流程依次为：lint -&gt; parser -&gt; preprocessor -&gt; standard -&gt; postprocessor -&gt; optimizer。这六个过程可以通过配置插件来定义我们最终想要的结果，然后进行package输出。例如，
  lint 代码校验检查，比较特殊，所以需要 release 命令命令行添加 -l 参数
  parser 预处理阶段，比如 less、sass、es6、react 前端模板等都在此处预编译处理
  preprocessor 标准化前处理插件
  standard 标准化插件，处理内置语法
  postprocessor 标准化后处理插件</p>

<p>  最终阶段为package打包阶段，打包是依赖的插件fpl，fpl可以对html、css、js进行分析打包，并且能打包分析html中引入的js，js中引入的css，功能十分强大，目前所在团队通用的是fis3体系（之前用过grunt、gulp，发现依然很多不爽的地方）具体文档可以查看官网或我的另一篇文章：
http://fis.baidu.com/
https://ouvens.github.io/frontend-build/2015/08/15/fis3-study-rearch.html</p>

<p>  fis3默认可以直接对我们的html进行资源引入打包处理，将scss和js里面的依赖关系层层递进分析打包，并生成resource Map表，程序运行时通过resource Map来加载模块。它的一个很大优势是不用我们书写构建任务和太多的配置。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"../../modules/sass/frozenjs.scss"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">async</span><span class="p">([</span><span class="s1">'zepto'</span><span class="p">,</span> <span class="s1">'frozen'</span><span class="p">,</span> <span class="s1">'./main'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">frozen</span><span class="p">,</span> <span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">main</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>看下fis3-packager-loader使用几个需要注意的地方：
- 可以方便的支持html，js，css的依赖引用打包
- 已集成到fis3构建中，简单配置后就可以使用
- 目前js支持同步打包，异步处理我们也可以自己做处理插件
- 依赖fis3环境，支持commonjs规范
- 不需要书写任务配置，这点是很方便的</p>

<h2 id="section">三、下一代前端打包工具</h2>
<p>  再来看看下一代模块打包工具rollup ( http://rollupjs.org/guide/ )和webpack2(这里原理相同，不赘述了)。
  rollup是一个模块打包工具：它可以将多个ES6模块转化为一个独立的打包文件，打包后的模块可以是 ES6、CommonJS、ES5……中的任一种格式。Rollup打包JavaScript模块具有两个新的优势：</p>

<p>  <strong>1、ES6到处的模块依然是可用的独立模块</strong>
  现在不少前端团队开始使用ES6 + babel + webpack的方式开发了，但是我们依然只能这样写代码，因为babel无法为我们解析模块加载的问题：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">'utils'</span> <span class="p">);</span>

<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">'Rollup'</span><span class="p">;</span>
<span class="nx">utils</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span> <span class="s1">'https://api.example.com?search='</span> <span class="o">+</span> <span class="nx">query</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">handleResponse</span> <span class="p">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>使用rollup，我们就可以这样使用了</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kr">import</span> <span class="p">{</span> <span class="nx">ajax</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'utils'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">'Rollup'</span><span class="p">;</span>
<span class="nx">ajax</span><span class="p">(</span> <span class="s1">'https://api.example.com?search='</span> <span class="o">+</span> <span class="nx">query</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">handleResponse</span> <span class="p">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  <strong>2、tree-shaking打包</strong>
  通过名叫 “tree-shaking” 的技术使打包的结果只包括实际用到的 exports。Three-shaking 的关键在于依赖 ES6 模块的静态结构。“静态结构”意味着在编译时他们是可分解的，而不用执行它们的任何代码，简单理解是ES6导出的部分如果在其它模块没有调用，rollup在输出时会直接把这部分作为死码删除。死码删除有一个很大的优势，就是现在我们可以根据需要随意地使模块或大或小，而不用担心打包后的大小，因为工具可以帮我筛选过滤，webpack 2也支持这一特性。例如下面两个模块：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="c1">// lib.js文件</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// main.js文件</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">'./lib.js'</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">foo</span><span class="p">());</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>  rollup打包合并处理后，新生成的文件main.js如下，lib.js中到处但是未被调用的模块被移除了。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="c1">// main.js</span>
<span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">foo</span><span class="p">());</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>再来总结下rollup：
- 支持ES6模块规范打包成其它任一格式规范
- 支持tree-shaking方式打包
- 方便接入构建，如gulp
- 需要书写配置任务</p>

<p><strong>另外需要了解的是，webpack2也具有这两大特性，不过webpack 2还在beta版，正式发布后估计仍然会取代rollup的地位。</strong></p>

<p>tree-shaking：http://www.2ality.com/2015/12/webpack-tree-shaking.html
面向未来打包：http://www.2ality.com/2015/12/bundling-modules-future.html</p>

<h2 id="section-1">四、总结</h2>
<p>  这里总结下，目前ES6的前端开发者越来越多，虽然ES6在前端的应用仍需要babel等工具协助完成，rollup又为ES6这一开发体系补上了一块新的木板，另外构建打包工具的迭代更新速度很快，webpack 2也携带了tree-shaking技术、结合babel支持es6模块打包出现，未来的团队也要因势而变，才能不断发展。</p>

</article>


<div class="tags">
	<strong>Tags:</strong> <a target="_blank" href="/tags/?tag=打包工具">打包工具</a>,&nbsp;<a target="_blank" href="/tags/?tag=rollup">rollup</a>,&nbsp;<a target="_blank" href="/tags/?tag=webpack2">webpack2</a>,&nbsp;<a target="_blank" href="/tags/?tag=tree-shaking">tree-shaking</a>
</div>


	<script src="/assets/js/github.comment.js"></script>
	<div class="gc-comments" data-repos="ouvens/ouvens.github.io" data-issues="3" >
	    <div class="gc-comments-title">
	        评论
	    </div>
	    <div class="gc-comments-info">
	        想在此留下评论，请访问 <a href="issues_link">issues_link</a> 提交评论
	    </div>
	</div>
</div>
</div>


    </div>
    
<div class="qr-code qr-code-pay" title="加个微信交流交流">
    <img src="/assets/qrcode/qr-code-person.jpg" width="200" height="200" alt="公众号">
    <p>加我赏红包，哈哈哈</p>
</div>

<div class="qr-code qr-code-wx" title="定期获取更新动态">
    <img src="/assets/qrcode/qrcode.jpg" width="200" height="200" alt="公众号">
    <p>欢迎关注 <strong>极限前端</strong> 公众号</p>
</div>


    
<footer class="site-footer">
  <div class="wrapper">
    <h3 class="footer-heading">极限前端</h3>
    <div class="site-navigation">
    	<p><strong>站内</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">关于</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/category/">所有文章</a>
        
        
        
          <li class="nav-link"><a href="/tags/">标签分类</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>
    <div class="site-contact">
    	<p><strong>相关链接</strong></p>
        <ul class="social-media-list">
      	<li>
      		<a href="mailto:1025224452@qq.com">
	      		<i class="icon-font i-star"></i>
	      		<span class="username">1025224452@qq.com</span>
      		</a>
      	</li>

      	
	      	
	      	<li>
	           <a href="https://github.com/ouvens" title="Fork me on GitHub">
	               <i class="icon-font i-heart"></i>
	               <span class="username">ouvens</span>
	           </a>
	        </li>
	      	
      	

      </ul>
    </div>
    <div class="site-signature">
    	<p class="rss-subscribe text"><strong>订阅<a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">极限前端, 极限前端社区, ouven的博客, ouvenzhang的博客, www.jixianqianduan.com, github地址, 前端技术, 讲述前端高效技术与前沿。</p>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="//1.url.cn/jslib/jquery/1.9.1/jquery.min.js" defer></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js" defer></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" defer></script>

<script src="/assets/js/main.js" defer></script>

    </body>
</html>
