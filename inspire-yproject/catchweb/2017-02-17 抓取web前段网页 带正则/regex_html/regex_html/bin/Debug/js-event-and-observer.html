<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="0FNbiBWk1FugWYo-RiGxQyIHebGeLoXp3HB7AxIFKy8" />
    <meta name="baidu-site-verification" content="tYoUqpkCCv" />
    <meta name="baidu-site-verification" content="IGN97NW90O" />
    
    <title>javascript基础--突变事件与观察者事件 | ouvenzhang的博客</title>

    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <link rel="dns-prefetch" href="cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="1.url.cn" />

    <meta name="description" itemprop="description" content="javascript基础--突变事件与观察者事件,javascript基础,突变事件 ">
    <meta itemprop="name" content="javascript基础--突变事件与观察者事件">
    <meta itemprop="image" content="http://ouvens.github.io/blog/assets/logo.png">
    <meta itemprop="keywords" name="keywords" content="javascript基础--突变事件与观察者事件,javascript基础,突变事件 ">

    
    <meta name="author" content="ouvenzhang">
    <meta name="copyright" content="&copy; ouvenzhang 2017">
    <meta name="protocol" content="1">
    

    <!-- External libraries -->
    <link rel="stylesheet" href="/assets/css/iconfont.css">
    <link rel="stylesheet" href="/css/monokai_sublime.css">

    <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  	<link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
  	<meta name="msapplication-TileColor" content="#ffffff">
  	<meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icons/icon.png">

  	<!-- Site styles -->
    <link rel="stylesheet" href="/css/main.css">

    <link rel="alternate" type="application/rss+xml" title="极限前端" href="http://ouvens.github.io//feed.xml" />
    <script>
    // 访问统计
    var domain = 'jixianqianduan.com';
    var oldDomain = 'ouvens.github.io';
    if(location.host === domain){
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?b536b128dc21c3d18fdc028f0609e3f0";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }else if(location.host === oldDomain){
        window.location.href = location.href.replace(oldDomain, domain);
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?041efd2cb345ca1b9dbdbb2383cb716d";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }

    // 链接提交

    if(location.protocol === 'https'){
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,t=document.referrer;if(!e.test(r)){var o="https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif";t?(o+="?r="+encodeURIComponent(document.referrer),r&&(o+="&l="+r)):r&&(o+="?l="+r);var i=new Image;i.src=o}}(window);
    }else{
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
    }


    </script>
</head>

    <body>
        <div class="navigation" role="banner">
    <div class="navigation-wrapper">
    <a href="/" class="logo">
    	
      <img src="/assets/logo.png" alt="极限前端">
      
    </a>
    <span class="search-input" id="search-input">
      <input type="text" value="" class="search-text" placeholder="输入搜索关键字">
      <i class="icon-font i-search search-btn"></i>
    </span>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
    	<i class="icon-font i-list fa fa-bars"></i>
    </a>
    <span class="nav" role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
      	
          
          <li class="nav-link">
            <a href="/about/">关于</a>
          </li>
          
        
          
        
          
        
          
        
          
          <li class="nav-link">
            <a href="/category/">所有文章</a>
          </li>
          
        
          
          <li class="nav-link">
            <a href="/tags/">标签分类</a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          <li id="github-info" class="nav-link" title="https://github.com/ouvens">
            <a class="github-info" href="https://github.com/ouvens" target="_blank">
            <img src="/assets/github.png" height="34" width="130" alt="github地址"></a>
          </li>
      </ul>
    </span>
  </div>
</div>

            <div class="page-content">
        <div class="post">
<div class="post-header-container has-cover">
	<header class="post-header">
	  <h1 class="title">javascript基础--突变事件与观察者事件</h1>
	  <p class="info">by <strong>ouven</strong></p>
	</header>
</div>
<div class="wrapper">



<div class="post-meta">
	<div class="post-date">2014年08月05日</div>
	<div class="post-categories">
	 in  
		<a target="_blank" href="/category/?cate=frontend-javascript">Frontend-javascript</a>
	  
	</div>
</div>	

<article class="post-content">
  <h3 id="section">一、问题背景</h3>

<h4 id="section-1">1.1、发现问题</h4>

<p>首先有这样一个问题，就是页面title后面莫名其妙hash值</p>

<p>这是一个带有flash的播放页面，开始，觉得这个问题我十分钟能搞定发到外网，测试同学稍等。十分钟过后我哭了~</p>

<h3 id="section-2">二、问题描述</h3>

<p>问题重现在IE环境下，如果页面有flash内容embed嵌入，同时页面URL中带有hash，在flash加载后会改变document.title，而且后面js每次和flash交互都会改变document.title，就是把hash内容加到title后面(http://code.google.com/p/swfobject/issues/detail?id=293)。这个被定义为IE的bug，怎么解决？
http://stackoverflow.com/questions/4562423/ie-title-changes-to-afterhash-if-the-page-has-a-url-with-and-has-flash-s
然后有了这个解决方案。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">originalTitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>   
<span class="nb">document</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">'onpropertychange'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">propertyName</span> <span class="o">===</span> <span class="s1">'title'</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="nx">originalTitle</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">originalTitle</span><span class="p">;</span>
        <span class="p">},</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
  
<span class="c1">//使用document.title=newtitle设置标题属性</span>
<span class="kd">function</span> <span class="nx">changeTitle</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">){</span>
    <span class="nx">originalTitle</span> <span class="o">=</span> <span class="nx">newTitle</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">newtitle</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">changeTitle</span><span class="p">(</span><span class="nx">originalTitle</span><span class="p">);</span>
</pre></td></tr></tbody></table>
</div>
</div>
<p>这里的方案是监听IE中document的propertychang事件，当flash改变document.title时，把title设置回来。当然也有人提出使用在flash操作时据改变，但是flash交互的地方太多了，而且改变时也会有个title闪一下的问题。除此之外，还想没有其它的好办法了。
然后，使用了这段推荐方法并没有解决所有的问题，因为有几点被忽略了：
(1) atatchEvent不是所有IE浏览器都能用的。这点好解决，兼容下就好了。
(2) propertychangge也不是所有IE浏览器能用的。这点还有什么方法可以去兼容实现呢？</p>

<p>因为IE11跟之前的IE又不一样了。
- (1) propertychange已经不被IE11支持了(http://stackoverflow.com/questions/24795769/propertychange-not-working-in-ie11</p>

<ul>
  <li>(2) attachEvent也被IE11放弃了
所以这段代码要改成这样：</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">originalTitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"#"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>    
<span class="kd">var</span> <span class="nx">isIE11OrGreater</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Trident/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/rv:11.0/</span><span class="p">));</span> <span class="c1">// IE11</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">'onpropertychange'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">propertyName</span> <span class="o">===</span> <span class="s1">'title'</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="nx">originalTitle</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
           <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">originalTitle</span><span class="p">;</span>
        <span class="p">},</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="cm">/**
 * IE 9的突变事件模型，使用DOMCharacterDataModified才行，ie11使用dom3事件模型，弃用了突变观察者
 * https://msdn.microsoft.com/library/bg182625(v=vs.85).aspx, 这里有较详细的介绍
 * 
 */</span>
<span class="nx">isIE11OrGreater</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMCharacterDataModified'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="nx">originalTitle</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
           <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">originalTitle</span><span class="p">;</span>
        <span class="p">},</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">changeTitle</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">){</span>
    <span class="nx">originalTitle</span> <span class="o">=</span> <span class="nx">newTitle</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">newTitle</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">changeTitle</span><span class="p">(</span><span class="nx">originalTitle</span><span class="p">);</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>这样为什么能解决？简单的解释是IE9使用addEventListener代替了原来的attachEvent处理事件，并且支持新的DOMCharacterDataModified突变事件。而ie9以后不再使用propertychange。</p>

<h3 id="section-3">二、突变事件</h3>

<h4 id="section-4">2.1、什么是突变事件？</h4>
<p>先看看普通的事件模型。下面这个图都见过，事件的机制、兼容性和实现，就不赘述了。</p>

<h4 id="section-5">2.2、那突变事件有什么不同？</h4>
<p>突变事件是指在dom元素改变时会触发的事件。例如</p>

<p>DOMAttrModified 突变事件报告对元素的属性列表的更改。此单一事件包括与插入、删除或更改属性相关的信息。</p>

<p>DOMNodeInserted、DOMNodeRemoved 和 DOMSubtreeModified</p>

<p>突变事件监视元素子项的结构更改，例如向元素子项添加了元素或者删除了元素子项。</p>

<p>注意  对于未反映在 HTML 属性中的属性（例如 input 元素上的 value），可以使用称为“defineProperty”的 ECMAScript 5 (JavaScript) 功能。本文档不介绍如何使用该对象迁移属性更改事件。defineProperty JavaScript API。例如json对象的属性改变等不属于突变事件。</p>

<h4 id="section-6">突变事件观察者</h4>
<p>什么是突变事件观察者，和普通事件模型的有什么不同？
突变观察者不是基于 Web 平台的事件模型。这是一个重用区别，这使它们能够更快地进行分派，而无需在 DOM 元素层次结构中对事件执行冒泡操作。</p>

<p>而且，突变观察者的目标是在通知你的观察者之前记录多项更改。它们批量提供突变记录，以避免在你的应用中滥发此类事件。相比之下，突变事件是同步发送的，可以中断正常的代码执行来通知你应用发生突变。尽管突变观察者采用延迟的通知模型，但仍可保证你的应用的观察者可以在下一个重画之前收到（并有机会处理）所有突变记录。
这两项更改会影响你的应用必须如何调整来支持突变观察者。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">mutationObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MutationObserver</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="nx">mutationObserver</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">someElement</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>https://msdn.microsoft.com/library/dn265032(v=vs.85).aspx[待续]</p>

</article>


<div class="tags">
	<strong>Tags:</strong> <a target="_blank" href="/tags/?tag=javascript基础">javascript基础</a>,&nbsp;<a target="_blank" href="/tags/?tag=突变事件">突变事件</a>
</div>


	<script src="/assets/js/github.comment.js"></script>
	<div class="gc-comments" data-repos="ouvens/ouvens.github.io" data-issues="3" >
	    <div class="gc-comments-title">
	        评论
	    </div>
	    <div class="gc-comments-info">
	        想在此留下评论，请访问 <a href="issues_link">issues_link</a> 提交评论
	    </div>
	</div>
</div>
</div>


    </div>
    
<div class="qr-code qr-code-pay" title="加个微信交流交流">
    <img src="/assets/qrcode/qr-code-person.jpg" width="200" height="200" alt="公众号">
    <p>加我赏红包，哈哈哈</p>
</div>

<div class="qr-code qr-code-wx" title="定期获取更新动态">
    <img src="/assets/qrcode/qrcode.jpg" width="200" height="200" alt="公众号">
    <p>欢迎关注 <strong>极限前端</strong> 公众号</p>
</div>


    
<footer class="site-footer">
  <div class="wrapper">
    <h3 class="footer-heading">极限前端</h3>
    <div class="site-navigation">
    	<p><strong>站内</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">关于</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/category/">所有文章</a>
        
        
        
          <li class="nav-link"><a href="/tags/">标签分类</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>
    <div class="site-contact">
    	<p><strong>相关链接</strong></p>
        <ul class="social-media-list">
      	<li>
      		<a href="mailto:1025224452@qq.com">
	      		<i class="icon-font i-star"></i>
	      		<span class="username">1025224452@qq.com</span>
      		</a>
      	</li>

      	
	      	
	      	<li>
	           <a href="https://github.com/ouvens" title="Fork me on GitHub">
	               <i class="icon-font i-heart"></i>
	               <span class="username">ouvens</span>
	           </a>
	        </li>
	      	
      	

      </ul>
    </div>
    <div class="site-signature">
    	<p class="rss-subscribe text"><strong>订阅<a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">极限前端, 极限前端社区, ouven的博客, ouvenzhang的博客, www.jixianqianduan.com, github地址, 前端技术, 讲述前端高效技术与前沿。</p>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="//1.url.cn/jslib/jquery/1.9.1/jquery.min.js" defer></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js" defer></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" defer></script>

<script src="/assets/js/main.js" defer></script>

    </body>
</html>
