<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="0FNbiBWk1FugWYo-RiGxQyIHebGeLoXp3HB7AxIFKy8" />
    <meta name="baidu-site-verification" content="tYoUqpkCCv" />
    <meta name="baidu-site-verification" content="IGN97NW90O" />
    
    <title>【原译】webpack 2和babel 6的tree-shaking | ouvenzhang的博客</title>

    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <link rel="dns-prefetch" href="cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="1.url.cn" />

    <meta name="description" itemprop="description" content="【原译】webpack 2和babel 6的tree-shaking,webpack,2和babel,6的tree-shaking ">
    <meta itemprop="name" content="【原译】webpack 2和babel 6的tree-shaking">
    <meta itemprop="image" content="http://ouvens.github.io/blog/assets/logo.png">
    <meta itemprop="keywords" name="keywords" content="【原译】webpack 2和babel 6的tree-shaking,webpack,2和babel,6的tree-shaking ">

    
    <meta name="author" content="ouvenzhang">
    <meta name="copyright" content="&copy; ouvenzhang 2017">
    <meta name="protocol" content="1">
    

    <!-- External libraries -->
    <link rel="stylesheet" href="/assets/css/iconfont.css">
    <link rel="stylesheet" href="/css/monokai_sublime.css">

    <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  	<link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
  	<meta name="msapplication-TileColor" content="#ffffff">
  	<meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/icons/icon.png">

  	<!-- Site styles -->
    <link rel="stylesheet" href="/css/main.css">

    <link rel="alternate" type="application/rss+xml" title="极限前端" href="http://ouvens.github.io//feed.xml" />
    <script>
    // 访问统计
    var domain = 'jixianqianduan.com';
    var oldDomain = 'ouvens.github.io';
    if(location.host === domain){
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?b536b128dc21c3d18fdc028f0609e3f0";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }else if(location.host === oldDomain){
        window.location.href = location.href.replace(oldDomain, domain);
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?041efd2cb345ca1b9dbdbb2383cb716d";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }

    // 链接提交

    if(location.protocol === 'https'){
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,t=document.referrer;if(!e.test(r)){var o="https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif";t?(o+="?r="+encodeURIComponent(document.referrer),r&&(o+="&l="+r)):r&&(o+="?l="+r);var i=new Image;i.src=o}}(window);
    }else{
        !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
    }


    </script>
</head>

    <body>
        <div class="navigation" role="banner">
    <div class="navigation-wrapper">
    <a href="/" class="logo">
    	
      <img src="/assets/logo.png" alt="极限前端">
      
    </a>
    <span class="search-input" id="search-input">
      <input type="text" value="" class="search-text" placeholder="输入搜索关键字">
      <i class="icon-font i-search search-btn"></i>
    </span>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
    	<i class="icon-font i-list fa fa-bars"></i>
    </a>
    <span class="nav" role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
      	
          
          <li class="nav-link">
            <a href="/about/">关于</a>
          </li>
          
        
          
        
          
        
          
        
          
          <li class="nav-link">
            <a href="/category/">所有文章</a>
          </li>
          
        
          
          <li class="nav-link">
            <a href="/tags/">标签分类</a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          <li id="github-info" class="nav-link" title="https://github.com/ouvens">
            <a class="github-info" href="https://github.com/ouvens" target="_blank">
            <img src="/assets/github.png" height="34" width="130" alt="github地址"></a>
          </li>
      </ul>
    </span>
  </div>
</div>

            <div class="page-content">
        <div class="post">
<div class="post-header-container has-cover">
	<header class="post-header">
	  <h1 class="title">【原译】webpack 2和babel 6的tree-shaking</h1>
	  <p class="info">by <strong>ouven</strong></p>
	</header>
</div>
<div class="wrapper">



<div class="post-meta">
	<div class="post-date">2016年06月17日</div>
	<div class="post-categories">
	 in  
		<a target="_blank" href="/category/?cate=article-translation">Article-translation</a>
	  
	</div>
</div>	

<article class="post-content">
  <p>  Rich Harris的模块打包机<a href="https://github.com/rollup/rollup">Rollup</a>提出了JavaScript世界的一个新特性：Tree-Shaking，为打包文件去掉不必要的导出内容。Rollup依赖<a href="http://exploringjs.com/es6/ch_modules.html#static-module-structure">ES6模块的静态结构</a>(讲解了imports内容和exports内容在JavaScript执行时是不变的)检测来决定哪个导出是不必要的。</p>

<p>  webpack 2的Tree-Shaking还在beta阶段。这篇文章讲解了它是如何工作的。也可以先看个demo：<a href="https://github.com/rauschma/tree-shaking-demo">tree-shaking-demo</a></p>

<h4 id="webpack-2">1、webpack 2如何排除无用导出</h4>

<p>  webpack的新beta版本webpack 2通过下面两步来排除无用的导出：</p>

<ul>
  <li>首先，所有的ES6模块文件都合并成一个打包后的文件。在这个文件中，没有被import过的exports是不会被合并进来的。</li>
  <li>其次，打包后的文件被合并minified时移除了不用的代码。所以，哪些没有被导出或没有被使用的入口就不会出现在minified压缩后的包里了。没有第一步的操作，不用的代码就不会被移除掉(而是作为一个export被注册进来)。</li>
</ul>

<p>  如果模块系统有静态结构，无用的导出将在打包的时候被检测出来。所以，webpack 2可以分析理解所有的ES6代码并且只在检测到是ES6模块时才使用tree-shaking。然而，只有import导入和export导出的模块才会被编译为ES5，如果你希望所有的打包文件都编译为ES5，你需要使用一个转译器来处理剩下来的文件。这篇文章中，我们将使用babel 6。</p>

<h4 id="es6-">2、ES6 代码</h4>

<p>  样例代码含有两个ES6 模块<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>helpers.js<span class="w">
</span></pre></td></tr></tbody></table>
</code>和<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>main.js<span class="w">
</span></pre></td></tr></tbody></table>
</code>。</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>// helpers.js
export function foo() {
    return 'foo';
}
export function bar() {
    return 'bar';
}
</pre></td></tr></tbody></table>
</div>
</div>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>// main.js
import {foo} from './helpers';

let elem = document.getElementById('output');
elem.innerHTML = `Output: ${foo()}`;
</pre></td></tr></tbody></table>
</div>
</div>

<p>  注意下导出的<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>heplers<span class="w">
</span></pre></td></tr></tbody></table>
</code>的<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>bar<span class="w">
</span></pre></td></tr></tbody></table>
</code>模块是没有在任何地方用到的。</p>

<h4 id="tree-shaking">3、不使用tree-shaking输出</h4>

<p>  正常使用Babel 6来转换的方式是这样的：</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="p">{</span><span class="w">
  </span><span class="err">presets:</span><span class="w"> </span><span class="err">['es2015'],</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table>
</div>
</div>

<p>  然而这种方式使用的<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>transform-es2015-modules-commonjs<span class="w">
</span></pre></td></tr></tbody></table>
</code>插件意味着Babel会将ES 6模块通过commonJs模块转换输出，然后webpack 2就不能进行tree-shaking分析了。</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre>function(module, exports) {
    
    'use strict';

    Object.defineProperty(exports, "__esModule", {
        value: true
    });
    exports.foo = foo;
    exports.bar = bar;
    function foo() {
        return 'foo';
    }
    function bar() {
        return 'bar';
    }
}
</pre></td></tr></tbody></table>
</div>
</div>

<p>  你会看到<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>bar<span class="w">
</span></pre></td></tr></tbody></table>
</code>成了导出的一部分，这样就成为无用代码存在于打包后文件中，而且不能被辨认出来。</p>

<h4 id="tree-shaking-1">4、 使用tree-shaking输出</h4>

<p>  我们想要的是用Babel编译ES6，但不是使用<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>transform-es2015-modules-commonjs<span class="w">
</span></pre></td></tr></tbody></table>
</code>。这时，唯一个可行的方法是在我们的配置文件中列出所有要处理的文件，当然除去那些我们不需要处理的，所以我们的做法是这样的：(<a href="https://github.com/babel/babel/blob/472ad1e6a6d4d0dd199078fdb08c5bc16c75b5a9/packages/babel-preset-es2015/index.js">demo</a>)</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="p">{</span><span class="w">
    </span><span class="err">plugins:</span><span class="w"> </span><span class="err">[</span><span class="w">
        </span><span class="err">'transform-es2015-template-literals',</span><span class="w">
        </span><span class="err">'transform-es2015-literals',</span><span class="w">
        </span><span class="err">'transform-es2015-function-name',</span><span class="w">
        </span><span class="err">'transform-es2015-arrow-functions',</span><span class="w">
        </span><span class="err">'transform-es2015-block-scoped-functions',</span><span class="w">
        </span><span class="err">'transform-es2015-classes',</span><span class="w">
        </span><span class="err">'transform-es2015-object-super',</span><span class="w">
        </span><span class="err">'transform-es2015-shorthand-properties',</span><span class="w">
        </span><span class="err">'transform-es2015-computed-properties',</span><span class="w">
        </span><span class="err">'transform-es2015-for-of',</span><span class="w">
        </span><span class="err">'transform-es2015-sticky-regex',</span><span class="w">
        </span><span class="err">'transform-es2015-unicode-regex',</span><span class="w">
        </span><span class="err">'check-es2015-constants',</span><span class="w">
        </span><span class="err">'transform-es2015-spread',</span><span class="w">
        </span><span class="err">'transform-es2015-parameters',</span><span class="w">
        </span><span class="err">'transform-es2015-destructuring',</span><span class="w">
        </span><span class="err">'transform-es2015-block-scoping',</span><span class="w">
        </span><span class="err">'transform-es2015-typeof-symbol',</span><span class="w">
        </span><span class="err">['transform-regenerator',</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">async:</span><span class="w"> </span><span class="err">false,</span><span class="w"> </span><span class="err">asyncGenerators:</span><span class="w"> </span><span class="err">false</span><span class="w"> </span><span class="p">}</span><span class="err">],</span><span class="w">
    </span><span class="err">],</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></pre></td></tr></tbody></table>
</div>
</div>

<p>  如果我们构建这个项目，<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>helper<span class="w">
</span></pre></td></tr></tbody></table>
</code>模块就是这样的：</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre>function(module, exports, __webpack_require__) {
    
    /* harmony export */ exports["foo"] = foo;
    /* unused harmony export bar */;

    function foo() {
        return 'foo';
    }
    function bar() {
        return 'bar';
    }
}
</pre></td></tr></tbody></table>
</div>
</div>

<p>  现在只导出<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>foo<span class="w">
</span></pre></td></tr></tbody></table>
</code>了，但是<code class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>bar<span class="w">
</span></pre></td></tr></tbody></table>
</code>仍然在那里。通过minified之后就可以了：</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>function (t, n, r) {
    function e() {
        return "foo"
    }

    n.foo = e
}
</pre></td></tr></tbody></table>
</div>
</div>

<p>  OK，再也没有多余的东西了。这里一个值的注意的地方是，webpack 2的tree-shaking只分析含有导入导出的ES6模块，而且使用其它的编译插件时一定需要注意下。</p>

<p>原文作者：Dr. Axel Rauschmayer</p>

<p>原译：ouven</p>

<p>原文地址： <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html">http://www.2ality.com/2015/12/webpack-tree-shaking.html</a></p>

</article>


<div class="tags">
	<strong>Tags:</strong> <a target="_blank" href="/tags/?tag=webpack">webpack</a>,&nbsp;<a target="_blank" href="/tags/?tag=2和babel">2和babel</a>,&nbsp;<a target="_blank" href="/tags/?tag=6的tree-shaking">6的tree-shaking</a>
</div>


	<script src="/assets/js/github.comment.js"></script>
	<div class="gc-comments" data-repos="ouvens/ouvens.github.io" data-issues="3" >
	    <div class="gc-comments-title">
	        评论
	    </div>
	    <div class="gc-comments-info">
	        想在此留下评论，请访问 <a href="issues_link">issues_link</a> 提交评论
	    </div>
	</div>
</div>
</div>


    </div>
    
<div class="qr-code qr-code-pay" title="加个微信交流交流">
    <img src="/assets/qrcode/qr-code-person.jpg" width="200" height="200" alt="公众号">
    <p>加我赏红包，哈哈哈</p>
</div>

<div class="qr-code qr-code-wx" title="定期获取更新动态">
    <img src="/assets/qrcode/qrcode.jpg" width="200" height="200" alt="公众号">
    <p>欢迎关注 <strong>极限前端</strong> 公众号</p>
</div>


    
<footer class="site-footer">
  <div class="wrapper">
    <h3 class="footer-heading">极限前端</h3>
    <div class="site-navigation">
    	<p><strong>站内</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">关于</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/category/">所有文章</a>
        
        
        
          <li class="nav-link"><a href="/tags/">标签分类</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>
    <div class="site-contact">
    	<p><strong>相关链接</strong></p>
        <ul class="social-media-list">
      	<li>
      		<a href="mailto:1025224452@qq.com">
	      		<i class="icon-font i-star"></i>
	      		<span class="username">1025224452@qq.com</span>
      		</a>
      	</li>

      	
	      	
	      	<li>
	           <a href="https://github.com/ouvens" title="Fork me on GitHub">
	               <i class="icon-font i-heart"></i>
	               <span class="username">ouvens</span>
	           </a>
	        </li>
	      	
      	

      </ul>
    </div>
    <div class="site-signature">
    	<p class="rss-subscribe text"><strong>订阅<a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">极限前端, 极限前端社区, ouven的博客, ouvenzhang的博客, www.jixianqianduan.com, github地址, 前端技术, 讲述前端高效技术与前沿。</p>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="//1.url.cn/jslib/jquery/1.9.1/jquery.min.js" defer></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js" defer></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" defer></script>

<script src="/assets/js/main.js" defer></script>

    </body>
</html>
